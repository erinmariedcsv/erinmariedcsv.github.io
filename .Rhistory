cat("\n=== MISSING DATA PATTERN ===\n")
missing_summary <- study2_complete %>%
summarise(
n_total = n(),
sleep_debt_missing = sum(is.na(sleep_debt)),
work_hours_missing = sum(is.na(OCQ180)),
age_missing = sum(is.na(RIDAGEYR)),
sex_missing = sum(is.na(sex)),
education_missing = sum(is.na(education)),
income_missing = sum(is.na(INDFMPIR))
)
print(missing_summary)
cat("\nNote: Outcome (sleep_debt) and key predictor (work_hours) have 0 missing by design\n")
cat("Missing values in additional predictors will be handled via single imputation\n")
# ============================================================================
# STEP 15: SINGLE IMPUTATION FOR ADDITIONAL PREDICTORS
# ============================================================================
cat("\n=== SINGLE IMPUTATION ===\n")
# Prepare data for imputation
study2_for_imputation <- study2_complete %>%
select(
SEQN,
sleep_debt,      # Outcome (no imputation)
OCQ180,          # Key predictor (no imputation)
RIDAGEYR,        # Age
sex,             # Sex
education,       # Education
INDFMPIR         # Income-to-poverty ratio
)
# Set up imputation - don't impute outcome or key predictor
imputation_method <- make.method(study2_for_imputation)
imputation_method["sleep_debt"] <- ""  # Don't impute outcome
imputation_method["OCQ180"] <- ""      # Don't impute key predictor
imputation_method["SEQN"] <- ""        # Don't impute ID
cat("Imputation methods:\n")
print(imputation_method)
# Perform single imputation (m=1)
set.seed(20242025)  # For reproducibility
cat("\nPerforming single imputation (MAR assumption)...\n")
imp <- mice(study2_for_imputation,
m = 1,                    # Single imputation
method = imputation_method,
maxit = 5,
print = FALSE)
# Extract imputed dataset
study2_imputed <- complete(imp, 1)
# Verify no missing values in additional predictors after imputation
cat("\n=== AFTER IMPUTATION ===\n")
missing_after <- study2_imputed %>%
summarise(
age_missing = sum(is.na(RIDAGEYR)),
sex_missing = sum(is.na(sex)),
education_missing = sum(is.na(education)),
income_missing = sum(is.na(INDFMPIR))
)
print(missing_after)
if(sum(missing_after) == 0) {
cat("✓ All additional predictors successfully imputed (no missing values)\n")
} else {
warning("⚠ Some missing values remain after imputation\n")
}
# ============================================================================
# STEP 16: CREATE FINAL ANALYSIS DATASET
# ============================================================================
study2_final <- study2_imputed %>%
select(
SEQN,
sleep_debt,      # OUTCOME
OCQ180,          # KEY PREDICTOR (work hours)
education,       # Multi-categorical (4 categories)
sex,             # Binary categorical
RIDAGEYR,        # Quantitative (age)
INDFMPIR         # Quantitative (income ratio)
) %>%
# Rename for clarity
rename(
work_hours = OCQ180,
age = RIDAGEYR,
income_poverty_ratio = INDFMPIR
)
cat("\n=== FINAL DATASET CREATED ===\n")
cat("Total observations:", nrow(study2_final), "\n")
cat("Total variables:", ncol(study2_final), "\n")
# ============================================================================
# STEP 17: FINAL DATA SUMMARY
# ============================================================================
cat("\n=== FINAL DATASET SUMMARY ===\n")
cat("\nQuantitative variables:\n")
summary(study2_final %>% select(sleep_debt, work_hours, age, income_poverty_ratio))
cat("\n=== CATEGORICAL VARIABLE DISTRIBUTIONS ===\n")
cat("\nSex:\n")
print(table(study2_final$sex))
cat("Percentage:", round(100 * prop.table(table(study2_final$sex)), 1), "%\n")
cat("\nEducation:\n")
print(table(study2_final$education))
cat("Percentage:", round(100 * prop.table(table(study2_final$education)), 1), "%\n")
```{r}
library(nhanesA)
library(tidyverse)
demo <- nhanes('P_DEMO')
sleep <- nhanes('P_SLQ')
occupation <- nhanes('P_OCQ')
study2_raw <- demo |>
left_join(sleep, by = "SEQN") |>
left_join(occupation, by = "SEQN")
study2_select <- study2_raw %>%
select(
SEQN,                              # Unique identifier
exam_stat = RIDSTATR,                          # Interview/examination status (keep for verification)
age = RIDAGEYR,                    # Age in years
sex = RIAGENDR,                    # Sex
educ_raw = DMDEDUC2,          # Education level (adults 20+)
incpov_ratio = INDFMPIR,   # Income-to-poverty ratio
sleep_wkday = SLD012,            # Sleep hours - weekdays/workdays
sleep_wkend = SLD013,            # Sleep hours - weekends
work_hours = OCQ180                # Hours worked last week (KEY PREDICTOR)
)
# Filter only exam_stat = 2
study2_exam <- study2_select %>%
filter(exam_stat == "Both interviewed and MEC examined")
table(study2_exam$exam_stat)
study2_adults <- study2_exam |>
filter(age >= 20)
nrow(study2_adults)
study2_clean <- study2_adults |>
mutate(
# Sleep hours: 77=Refused, 99=Don't know
sleep_wkday = ifelse(sleep_wkday %in% c(77, 99), NA, sleep_wkday),
sleep_wkend = ifelse(sleep_wkend %in% c(77, 99), NA, sleep_wkend),
# Work hours: 77777=Refused, 99999=Don't know
work_hours = ifelse(work_hours %in% c(77777, 99999), NA, work_hours),
# Education: 7=Refused, 9=Don't know
educ_raw = ifelse(educ_raw %in% c(7, 9), NA, educ_raw)
)
study2_clean <- study2_clean |>
mutate(
# Calculate weighted average sleep hours per night = (5 weekdays * weekday sleep + 2 weekend days * weekend sleep) / 7
avg_sleep_hrs = (5 * sleep_wkday + 2 * sleep_wkend) / 7,
# Age-appropriate sleep recommendations (National Sleep Foundation)
# Adults 18-64: 7-9 hours (use 8 as target)
# Older adults 65+: 7-8 hours (use 7.5 as target)
recommended_sleep = case_when(
age >= 20 & age <= 64 ~ 8,
age >= 65 ~ 7.5,
TRUE ~ NA_real_
),
# Calculate sleep debt (positive = sleep deprived, negative = extra sleep)
sleep_debt = recommended_sleep - avg_sleep_hrs
)
summary(study2_clean$sleep_debt)
study2_clean <- study2_clean %>%
mutate(
# Sex (binary categorical)
sex_numeric = as.numeric(sex),
# Keep existing sex factor for labels if desired
# Education (multi-categorical: 4 categories)
# Collapse codes 1 (Less than 9th grade) and 2 (9-11th grade)
education = case_when(
educ_raw %in% c(1, 2) ~ "Less than HS",
educ_raw == 3 ~ "HS Grad",
educ_raw == 4 ~ "Some College",
educ_raw == 5 ~ "College Grad",
TRUE ~ NA_character_
),
education = factor(education,
levels = c("Less than HS", "HS Grad",
"Some College", "College Grad"))
)
# Drop unused factor levels
study2_clean <- study2_clean |>
droplevels()
# Check categorical variables
cat("\nSex Distribution:\n")
table(study2_clean$sex, useNA = "ifany")
cat("\nEducation Distribution:\n")
table(study2_clean$education, useNA = "ifany")
study2_complete <- study2_clean %>%
filter(!is.na(sleep_debt) & !is.na(work_hours))
nrow(study2_complete)
cat("\n=== PREDICTOR VERIFICATION ===\n")
# Key predictor (work_hours - Work hours)
cat("\nKey Predictor - Work Hours (OCQ180):\n")
cat("  Range:", min(study2_complete$work_hours, na.rm=TRUE), "-",
max(study2_complete$work_hours, na.rm=TRUE), "\n")
cat("  Unique values:", length(unique(study2_complete$work_hours)), "\n")
cat("  Missing:", sum(is.na(study2_complete$work_hours)), "\n")
# Quantitative predictors
cat("\nQuantitative Predictors:\n")
cat("  Age (RIDAGEYR):\n")
cat("    Range:", min(study2_complete$age, na.rm=TRUE), "-",
max(study2_complete$age, na.rm=TRUE), "\n")
cat("    Unique values:", length(unique(study2_complete$age)), "\n")
cat("    Missing:", sum(is.na(study2_complete$age)), "\n")
cat("  Income-to-Poverty Ratio (INDFMPIR):\n")
cat("    Range:", min(study2_complete$incpov_ratio, na.rm=TRUE), "-",
max(study2_complete$incpov_ratio, na.rm=TRUE), "\n")
cat("    Unique values:", length(unique(na.omit(study2_complete$incpov_ratio))), "\n")
cat("    Missing:", sum(is.na(study2_complete$incpov_ratio)), "\n")
# Categorical predictors
cat("\nCategorical Predictors:\n")
cat("  Sex (binary):\n")
print(table(study2_complete$sex, useNA = "ifany"))
cat("\n  Education (multi-categorical - REQUIRED 3-6 categories, 30+ each):\n")
print(table(study2_complete$education, useNA = "ifany"))
# Check if education meets 30+ per category requirement
edu_table <- table(study2_complete$education)
if(any(edu_table < 30)) {
warning("Some education categories have fewer than 30 observations!")
cat("Categories with < 30 obs:", names(edu_table[edu_table < 30]), "\n")
}
# Select variables of interest
vars_of_interest <- c("avg_sleep_hrs", "age", "sex", "education", "work_hours", "incpov_ratio")
# Count subjects with complete data on all these variables
num_complete_subjects <- sum(complete.cases(study2_clean[, vars_of_interest]))
num_complete_subjects
---
title: "P2Study2"
library(nhanesA)
library(tidyverse)
knitr::opts_chunk$set(comment = NA)
```
library(nhanesA)
library(tidyverse)
demo <- nhanes('P_DEMO')
sleep <- nhanes('P_SLQ')
occupation <- nhanes('P_OCQ')
study2_raw <- demo |>
left_join(sleep, by = "SEQN") |>
left_join(occupation, by = "SEQN")
cat("Initial merged dataset:", nrow(study2_raw), "observations\n")
```
---
title: "P2Study2"
demo <- nhanes('P_DEMO')
sleep <- nhanes('P_SLQ')
occupation <- nhanes('P_OCQ')
study2_raw <- demo |>
left_join(sleep, by = "SEQN") |>
left_join(occupation, by = "SEQN")
cat("Initial merged dataset:", nrow(study2_raw), "observations\n")
# Select Variables
study2_select <- study2_raw %>%
select(
SEQN,                              # Unique identifier
exam_stat = RIDSTATR,              # Interview/examination status
age = RIDAGEYR,                    # Age in years
sex = RIAGENDR,                    # Sex
educ_raw = DMDEDUC2,               # Education level (adults 20+)
incpov_ratio = INDFMPIR,           # Income-to-poverty ratio
sleep_wkday = SLD012,              # Sleep hours - weekdays/workdays
sleep_wkend = SLD013,              # Sleep hours - weekends
work_hours = OCQ180                # Hours worked last week (KEY PREDICTOR)
)
cat("After selecting variables:", nrow(study2_select), "observations\n")
# Filter to Examined Participants
study2_exam <- study2_select %>%
filter(exam_stat == "Both interviewed and MEC examined")
cat("\n=== RIDSTATR DISTRIBUTION ===\n")
print(table(study2_exam$exam_stat))
cat("\nAfter filtering to examined participants:", nrow(study2_exam), "observations\n")
# Filter to Working-Age Adults (20-64 years)
study2_adults <- study2_exam |>
filter(age >= 20 & age <= 64)
cat("\nAfter filtering to adults 20-64 years:", nrow(study2_adults), "observations\n")
cat("Age range:", min(study2_adults$age), "to", max(study2_adults$age), "years\n")
# Handle Missing Value Codes
study2_clean <- study2_adults |>
mutate(
# Sleep hours: 77=Refused, 99=Don't know
sleep_wkday = ifelse(sleep_wkday %in% c(77, 99), NA, sleep_wkday),
sleep_wkend = ifelse(sleep_wkend %in% c(77, 99), NA, sleep_wkend),
# Work hours: 77777=Refused, 99999=Don't know
work_hours = ifelse(work_hours %in% c(77777, 99999), NA, work_hours),
# Education: 7=Refused, 9=Don't know
educ_raw = ifelse(educ_raw %in% c(7, 9), NA, educ_raw)
)
cat("\nAfter coding missing values:", nrow(study2_clean), "observations\n")
# Create Outcome Variable (Sleep Debt)
study2_clean <- study2_clean |>
mutate(
# Calculate average sleep hours per night
# (5 weekdays * weekday sleep + 2 weekend days * weekend sleep) / 7
avg_sleep_hrs = (5 * sleep_wkday + 2 * sleep_wkend) / 7,
# Age-appropriate sleep recommendations (National Sleep Foundation 2015)
# Adults 20-64: 8 hours
recommended_sleep = 8.0,
# Calculate sleep debt (positive = sleep deprived, negative = extra sleep)
sleep_debt = recommended_sleep - avg_sleep_hrs
)
cat("\n=== SLEEP DEBT OUTCOME (Before filtering work hours) ===\n")
summary(study2_clean$sleep_debt)
cat("Number of unique values:", length(unique(na.omit(study2_clean$sleep_debt))), "\n")
cat("Missing sleep_debt:", sum(is.na(study2_clean$sleep_debt)), "\n")
# Create Factor Variables
study2_clean <- study2_clean %>%
mutate(
# Sex - keep as factor with labels
sex = factor(sex,
levels = c(1, 2),
labels = c("Male", "Female")),
# Education (multi-categorical: 4 categories)
education = case_when(
educ_raw %in% c(1, 2) ~ "Less than HS",
educ_raw == 3 ~ "HS Grad",
educ_raw == 4 ~ "Some College",
educ_raw == 5 ~ "College Grad",
TRUE ~ NA_character_
),
education = factor(education,
levels = c("Less than HS", "HS Grad",
"Some College", "College Grad"))
)
# Drop unused factor levels
study2_clean <- study2_clean |>
droplevels()
cat("\n=== CATEGORICAL VARIABLES (Before filtering work hours) ===\n")
cat("Sex Distribution:\n")
print(table(study2_clean$sex, useNA = "ifany"))
cat("\nEducation Distribution:\n")
print(table(study2_clean$education, useNA = "ifany"))
# Work Hours Distribution - BEFORE Filtering
cat("\n=== WORK HOURS DISTRIBUTION (BEFORE FILTERING) ===\n")
cat("Total observations with work hours data:", sum(!is.na(study2_clean$work_hours)), "\n")
cat("\nWork hours summary:\n")
print(summary(study2_clean$work_hours))
cat("\nTop 10 most common work hour values:\n")
work_table <- sort(table(study2_clean$work_hours), decreasing = TRUE)[1:10]
print(work_table)
cat("\nPercentage at exactly 40 hours:",
round(100 * sum(study2_clean$work_hours == 40, na.rm=TRUE) /
sum(!is.na(study2_clean$work_hours)), 2), "%\n")
cat("\nExtreme values to be excluded:\n")
cat("  Work hours < 6:", sum(study2_clean$work_hours < 6, na.rm=TRUE), "observations\n")
cat("  Work hours > 78:", sum(study2_clean$work_hours > 78, na.rm=TRUE), "observations\n")
cat("  Total to exclude:",
sum(study2_clean$work_hours < 6, na.rm=TRUE) + sum(study2_clean$work_hours > 78, na.rm=TRUE),
"observations\n")
# Histogram - BEFORE Filtering
ggplot(study2_clean, aes(x = work_hours)) +
geom_histogram(binwidth = 5, fill = "steelblue", color = "white") +
labs(title = "Distribution of Work Hours per Week (Before Filtering)",
subtitle = "Includes extreme values",
x = "Hours Worked Last Week",
y = "Count") +
theme_minimal()
# Filter to Complete Cases on Outcome and Key Predictor
cat("\n=== FILTERING TO COMPLETE CASES ===\n")
# First, filter to complete outcome and key predictor
study2_complete_pre <- study2_clean %>%
filter(!is.na(sleep_debt) & !is.na(work_hours))
cat("After filtering to complete outcome and key predictor:",
nrow(study2_complete_pre), "observations\n")
# Filter Work Hours to 6-78 Range
cat("\n=== FILTERING WORK HOURS TO 6-78 RANGE ===\n")
# Filter work hours to reasonable range
study2_complete <- study2_complete_pre %>%
filter(work_hours >= 6 & work_hours <= 78)
cat("After filtering work hours to 6-78 range:",
nrow(study2_complete), "observations\n")
cat("Percentage retained from pre-filter:",
round(100 * nrow(study2_complete) / nrow(study2_complete_pre), 1), "%\n")
# Verify Sample Size Requirements
cat("\n=== SAMPLE SIZE VERIFICATION ===\n")
cat("Final complete cases (outcome + key predictor, work hours 6-78):",
nrow(study2_complete), "observations\n")
if(nrow(study2_complete) < 500) {
cat("⚠ Sample size is below 500!\n")
} else if(nrow(study2_complete) > 7500) {
cat("⚠ Sample size exceeds 7,500!\n")
} else {
cat("✓ Sample size is within acceptable range (500-7,500)\n")
}
# Work Hours Distribution - AFTER Filtering
cat("\n=== WORK HOURS DISTRIBUTION (AFTER FILTERING TO 6-78) ===\n")
cat("Work hours summary:\n")
print(summary(study2_complete$work_hours))
cat("\nUnique work hour values:", length(unique(study2_complete$work_hours)), "\n")
if(length(unique(study2_complete$work_hours)) < 15) {
cat("⚠ Work hours has fewer than 15 unique values!\n")
} else {
cat("✓ Work hours has 15+ unique values (requirement met)\n")
}
cat("\nTop 10 most common work hour values (after filtering):\n")
work_table_filtered <- sort(table(study2_complete$work_hours), decreasing = TRUE)[1:10]
print(work_table_filtered)
cat("\nPercentage at exactly 40 hours (after filtering):",
round(100 * sum(study2_complete$work_hours == 40) / nrow(study2_complete), 2), "%\n")
# Histogram - AFTER Filtering
ggplot(study2_complete, aes(x = work_hours)) +
geom_histogram(binwidth = 2, fill = "steelblue", color = "white", alpha = 0.8) +
geom_vline(xintercept = 40, color = "red", linetype = "dashed", linewidth = 1) +
annotate("text", x = 40, y = Inf,
label = paste0("40 hrs\n(",
round(100*sum(study2_complete$work_hours==40)/nrow(study2_complete), 1),
"%)"),
vjust = 1.2, hjust = -0.05, color = "red", size = 3.5) +
scale_x_continuous(breaks = seq(0, 80, 10)) +
labs(
title = "Distribution of Weekly Work Hours (After Filtering: 6-78 hours)",
subtitle = paste0("N = ", nrow(study2_complete), " | Ages 20-64"),
x = "Hours Worked Last Week",
y = "Number of Observations"
) +
theme_minimal() +
theme(plot.title = element_text(face = "bold"))
# Boxplot - AFTER Filtering
ggplot(study2_complete, aes(y = work_hours)) +
geom_boxplot(fill = "lightblue") +
labs(title = "Boxplot of Work Hours (After Filtering)",
y = "Hours Worked Last Week") +
theme_minimal()
# Check Predictor Requirements
cat("\n=== PREDICTOR VERIFICATION ===\n")
# Key predictor (work_hours)
cat("\nKey Predictor - Work Hours:\n")
cat("  Range:", min(study2_complete$work_hours), "-",
max(study2_complete$work_hours), "hours\n")
cat("  Unique values:", length(unique(study2_complete$work_hours)), "\n")
cat("  Missing:", sum(is.na(study2_complete$work_hours)), "\n")
cat("  Mean (SD):", round(mean(study2_complete$work_hours), 1),
"(", round(sd(study2_complete$work_hours), 1), ")\n")
# Quantitative predictors
cat("\nQuantitative Predictors:\n")
cat("\n  Age:\n")
cat("    Range:", min(study2_complete$age), "-",
max(study2_complete$age), "years\n")
cat("    Unique values:", length(unique(study2_complete$age)), "\n")
cat("    Missing:", sum(is.na(study2_complete$age)), "\n")
cat("    Mean (SD):", round(mean(study2_complete$age), 1),
"(", round(sd(study2_complete$age), 1), ")\n")
cat("\n  Income-to-Poverty Ratio:\n")
cat("    Range:", round(min(study2_complete$incpov_ratio, na.rm=TRUE), 2), "-",
round(max(study2_complete$incpov_ratio, na.rm=TRUE), 2), "\n")
cat("    Unique values:", length(unique(na.omit(study2_complete$incpov_ratio))), "\n")
cat("    Missing:", sum(is.na(study2_complete$incpov_ratio)), "\n")
cat("    Mean (SD):", round(mean(study2_complete$incpov_ratio, na.rm=TRUE), 2),
"(", round(sd(study2_complete$incpov_ratio, na.rm=TRUE), 2), ")\n")
# Categorical predictors
cat("\nCategorical Predictors:\n")
cat("\n  Sex (binary):\n")
sex_table <- table(study2_complete$sex, useNA = "ifany")
print(sex_table)
if(any(sex_table < 30)) {
cat("    ⚠ Some sex categories have fewer than 30 observations!\n")
}
cat("\n  Education (multi-categorical - REQUIRED 3-6 categories, 30+ each):\n")
edu_table <- table(study2_complete$education, useNA = "ifany")
print(edu_table)
# Check if education meets 30+ per category requirement
if(any(edu_table[!is.na(names(edu_table))] < 30)) {
cat("    ⚠ Some education categories have fewer than 30 observations!\n")
cat("    Categories with < 30 obs:",
names(edu_table[edu_table < 30 & !is.na(names(edu_table))]), "\n")
} else {
cat("    ✓ All education categories have 30+ observations\n")
}
# Check outcome variable
cat("\n=== OUTCOME VARIABLE ===\n")
cat("Sleep Debt:\n")
cat("  Range:", round(min(study2_complete$sleep_debt), 2), "to",
round(max(study2_complete$sleep_debt), 2), "hours\n")
cat("  Unique values:", length(unique(study2_complete$sleep_debt)), "\n")
if(length(unique(study2_complete$sleep_debt)) < 15) {
cat("  ⚠ Sleep debt has fewer than 15 unique values!\n")
} else {
cat("  ✓ Sleep debt has 15+ unique values (requirement met)\n")
}
cat("  Missing:", sum(is.na(study2_complete$sleep_debt)), "\n")
cat("  Mean (SD):", round(mean(study2_complete$sleep_debt), 2),
"(", round(sd(study2_complete$sleep_debt), 2), ")\n")
# Check Missing Data Pattern
cat("\n=== MISSING DATA PATTERN ===\n")
missing_summary <- study2_complete %>%
summarise(
n_total = n(),
sleep_debt_missing = sum(is.na(sleep_debt)),
work_hours_missing = sum(is.na(work_hours)),
age_missing = sum(is.na(age)),
sex_missing = sum(is.na(sex)),
education_missing = sum(is.na(education)),
income_missing = sum(is.na(incpov_ratio))
)
print(missing_summary)
cat("\nNote: Outcome (sleep_debt) and key predictor (work_hours) have 0 missing by design\n")
cat("Missing values in additional predictors will be handled via single imputation later\n")
# Summary
cat("\n=== FINAL SUMMARY (Before Imputation) ===\n")
cat("Total complete cases:", nrow(study2_complete), "\n")
cat("Age range: 20-64 years (working-age adults)\n")
cat("Work hours range: 6-78 hours (extremes excluded)\n")
cat("\nVariables:\n")
cat("  - Outcome: sleep_debt\n")
cat("  - Key predictor: work_hours (quantitative)\n")
cat("  - Additional predictors:\n")
cat("    * education (multi-categorical, 4 levels)\n")
cat("    * sex (binary categorical)\n")
cat("    * age (quantitative)\n")
cat("    * incpov_ratio (quantitative)\n")
num_complete_subjects <- sum(complete.cases(study2_clean[, vars_of_interest]))
# Select variables of interest
vars_of_interest <- c("avg_sleep_hrs", "age", "sex", "education", "work_hours", "incpov_ratio")
# Count subjects with complete data on all these variables
num_complete_subjects <- sum(complete.cases(study2_clean[, vars_of_interest]))
num_complete_subjects
View(study2_clean)
# Select variables of interest
vars_of_interest <- c("avg_sleep_hrs", "age", "education", "work_hours", "incpov_ratio")
# Count subjects with complete data on all these variables
num_complete_subjects <- sum(complete.cases(study2_clean[, vars_of_interest]))
num_complete_subjects
View(study2_raw)
View(study2_complete)
